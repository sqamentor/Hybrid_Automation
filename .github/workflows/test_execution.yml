name: Automation Test Execution

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: true
        default: 'staging'
        type: choice
        options:
          - dev
          - staging
          - production
      browser:
        description: 'Browser'
        required: true
        default: 'chromium'
        type: choice
        options:
          - chromium
          - chrome
          - firefox

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.11', '3.12']
        test-suite: ['smoke', 'regression', 'integration']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Install Playwright browsers
        run: |
          playwright install --with-deps chromium
      
      - name: Create directories
        run: |
          mkdir -p logs screenshots videos traces reports allure-results
      
      - name: Run tests
        env:
          TEST_ENV: ${{ github.event.inputs.environment || 'staging' }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          DB_STAGING_USERNAME: ${{ secrets.DB_STAGING_USERNAME }}
          DB_STAGING_PASSWORD: ${{ secrets.DB_STAGING_PASSWORD }}
        run: |
          pytest -m ${{ matrix.test-suite }} \
            --env=$TEST_ENV \
            --browser=${{ github.event.inputs.browser || 'chromium' }} \
            --headless \
            -n auto \
            --alluredir=allure-results \
            --html=reports/report_${{ matrix.test-suite }}.html \
            --self-contained-html
      
      - name: Generate Allure report
        if: always()
        run: |
          pip install allure-pytest
          allure generate allure-results --clean -o allure-report
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results-${{ matrix.python-version }}-${{ matrix.test-suite }}
          path: |
            reports/
            allure-results/
            allure-report/
            screenshots/
            logs/
      
      - name: Upload screenshots on failure
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: screenshots-${{ matrix.test-suite }}
          path: screenshots/
      
      - name: Publish test results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: reports/junit.xml
      
      - name: Comment PR with results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'reports/report_${{ matrix.test-suite }}.html';
            if (fs.existsSync(reportPath)) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: 'âœ… Test suite **${{ matrix.test-suite }}** completed. Check artifacts for detailed results.'
              });
            }
  
  docker-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Build Docker image
        run: |
          docker build -t automation-framework:latest -f docker/Dockerfile .
      
      - name: Run tests in Docker
        run: |
          docker run --rm \
            -e TEST_ENV=staging \
            -v $(pwd)/reports:/app/reports \
            -v $(pwd)/allure-results:/app/allure-results \
            automation-framework:latest \
            pytest -m smoke --headless -n auto
      
      - name: Upload Docker test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: docker-test-results
          path: |
            reports/
            allure-results/
